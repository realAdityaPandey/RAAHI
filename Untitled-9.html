<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Rides - Raahi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            padding-bottom: 4rem;
        }
        
        .bottom-nav-item.active {
            color: #000;
        }
        
        .tab.active {
            color: #000;
            border-bottom: 2px solid #000;
        }
        
        .loading-spinner {
            display: inline-block;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold text-gray-900">My Rides</h1>
        </div>
    </header>

    <!-- Tabs -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8">
                <button class="tab active py-4 px-2 text-sm font-medium" data-tab="upcoming">
                    Upcoming Rides
                </button>
                <button class="tab py-4 px-2 text-sm font-medium text-gray-500" data-tab="past">
                    Past Rides
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <!-- Upcoming Rides -->
        <div id="upcomingRides" class="space-y-4">
            <!-- Loading skeletons -->
            <div class="skeleton-item bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <div class="h-5 w-20 skeleton rounded"></div>
                        <div class="h-5 w-32 skeleton"></div>
                    </div>
                    <div class="h-5 w-16 skeleton"></div>
                </div>
                <div class="space-y-3">
                    <div class="flex items-start">
                        <div class="w-5 h-5 skeleton rounded-full mr-2"></div>
                        <div class="flex-1">
                            <div class="h-5 w-32 skeleton mb-1"></div>
                            <div class="h-4 w-48 skeleton"></div>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="w-5 h-5 skeleton rounded-full mr-2"></div>
                        <div class="flex-1">
                            <div class="h-5 w-32 skeleton mb-1"></div>
                            <div class="h-4 w-48 skeleton"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="flex -space-x-2">
                                <div class="w-8 h-8 skeleton rounded-full"></div>
                                <div class="w-8 h-8 skeleton rounded-full"></div>
                            </div>
                            <div class="h-4 w-24 skeleton"></div>
                        </div>
                        <div class="flex space-x-2">
                            <div class="h-8 w-20 skeleton rounded-lg"></div>
                            <div class="h-8 w-20 skeleton rounded-lg"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- No rides message (initially hidden) -->
            <div id="noUpcomingRidesMessage" class="hidden bg-white rounded-xl shadow-sm p-6 text-center">
                <i class="fas fa-car-side text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No upcoming rides</h3>
                <p class="text-gray-600">You don't have any upcoming rides yet.</p>
                <div class="mt-4 flex justify-center space-x-4">
                    <a href="Untitled-2.html" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        Offer a Ride
                    </a>
                    <a href="Untitled-1.html" class="px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50 transition">
                        Find a Ride
                    </a>
                </div>
            </div>
        </div>

        <!-- Past Rides -->
        <div id="pastRides" class="space-y-4 hidden">
            <!-- Loading skeletons -->
            <div class="skeleton-item bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <div class="h-5 w-20 skeleton rounded"></div>
                        <div class="h-5 w-32 skeleton"></div>
                    </div>
                    <div class="h-5 w-16 skeleton"></div>
                </div>
                <div class="space-y-3">
                    <div class="flex items-start">
                        <div class="w-5 h-5 skeleton rounded-full mr-2"></div>
                        <div class="flex-1">
                            <div class="h-5 w-32 skeleton mb-1"></div>
                            <div class="h-4 w-48 skeleton"></div>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="w-5 h-5 skeleton rounded-full mr-2"></div>
                        <div class="flex-1">
                            <div class="h-5 w-32 skeleton mb-1"></div>
                            <div class="h-4 w-48 skeleton"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 skeleton rounded-full"></div>
                            <div>
                                <div class="h-5 w-24 skeleton mb-1"></div>
                                <div class="h-4 w-16 skeleton"></div>
                            </div>
                        </div>
                        <div class="h-8 w-20 skeleton rounded-lg"></div>
                    </div>
                </div>
            </div>
            
            <!-- No rides message (initially hidden) -->
            <div id="noPastRidesMessage" class="hidden bg-white rounded-xl shadow-sm p-6 text-center">
                <i class="fas fa-history text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No past rides</h3>
                <p class="text-gray-600">Your ride history will appear here.</p>
            </div>
        </div>
    </div>

    <!-- Passenger Details Modal (Hidden by default) -->
    <div id="passengersModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Ride Passengers</h3>
                <button id="closePassengersBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="passengersContent" class="p-4">
                <!-- Passengers will be loaded here -->
                <div class="skeleton-item space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full skeleton"></div>
                            <div>
                                <div class="h-5 w-32 skeleton mb-1"></div>
                                <div class="h-4 w-24 skeleton"></div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <div class="h-8 w-20 skeleton rounded-lg"></div>
                            <div class="h-8 w-20 skeleton rounded-lg"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Requests Modal (Hidden by default) -->
    <div id="requestsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Booking Requests</h3>
                <button id="closeRequestsBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="requestsContent" class="p-4">
                <!-- Requests will be loaded here -->
                <div class="skeleton-item space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full skeleton"></div>
                            <div>
                                <div class="h-5 w-32 skeleton mb-1"></div>
                                <div class="h-4 w-24 skeleton"></div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <div class="h-8 w-20 skeleton rounded-lg"></div>
                            <div class="h-8 w-20 skeleton rounded-lg"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200">
        <div class="flex justify-around items-center h-16">
            <a href="Untitled-5.html" class="bottom-nav-item flex flex-col items-center text-sm text-gray-600">
                <i class="fas fa-home text-xl mb-1"></i>
                <span>Home</span>
            </a>
            <a href="Untitled-1.html" class="bottom-nav-item flex flex-col items-center text-sm text-gray-600">
                <i class="fas fa-search text-xl mb-1"></i>
                <span>Find</span>
            </a>
            <a href="Untitled-2.html" class="bottom-nav-item flex flex-col items-center text-sm text-gray-600">
                <i class="fas fa-car text-xl mb-1"></i>
                <span>Offer</span>
            </a>
            <a href="Untitled-9.html" class="bottom-nav-item active flex flex-col items-center text-sm">
                <i class="fas fa-list text-xl mb-1"></i>
                <span>My Rides</span>
            </a>
            <a href="Untitled-4.html" class="bottom-nav-item flex flex-col items-center text-sm text-gray-600">
                <i class="fas fa-user text-xl mb-1"></i>
                <span>Profile</span>
            </a>
        </div>
    </nav>

    <!-- Chat Modal (Hidden by default) -->
    <div id="chatModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl max-w-md w-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 id="chatModalTitle" class="text-lg font-semibold">Chat</h3>
                <button id="closeChatBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                <!-- Chat messages will be appended here -->
            </div>
            <form id="chatForm" class="p-4 border-t border-gray-200 flex space-x-2">
                <input type="text" id="chatInput" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-600" placeholder="Type a message..." autocomplete="off" />
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Send</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase functions
        import { 
            getCurrentUser, 
            getUserProfile, 
            getUserRides,
            getUserBookings,
            getRideBookings,
            getRide,
            updateRide,
            updateBookingStatus,
            deleteRide
        } from './firebase.js';

        // DOM Elements
        const tabs = document.querySelectorAll('.tab');
        const upcomingRides = document.getElementById('upcomingRides');
        const pastRides = document.getElementById('pastRides');
        const noUpcomingRidesMessage = document.getElementById('noUpcomingRidesMessage');
        const noPastRidesMessage = document.getElementById('noPastRidesMessage');
        const passengersModal = document.getElementById('passengersModal');
        const closePassengersBtn = document.getElementById('closePassengersBtn');
        const passengersContent = document.getElementById('passengersContent');
        const requestsModal = document.getElementById('requestsModal');
        const closeRequestsBtn = document.getElementById('closeRequestsBtn');
        const requestsContent = document.getElementById('requestsContent');
        
        // Current user data
        let currentUser = null;
        let userProfile = null;
        
        // Initialize
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                currentUser = await getCurrentUser();
                if (!currentUser) {
                    // User is not logged in, redirect to login page
                    window.location.href = 'Untitled-3.html';
                    return;
                }
                
                // Get user profile
                userProfile = await getUserProfile(currentUser.uid);
                if (!userProfile || !(userProfile.profileComplete || userProfile.isProfileComplete)) {
                    // Profile not complete, redirect to profile completion page
                    window.location.href = 'Untitled-6.html';
                    return;
                }
                
                // Load rides
                await loadRides();
            } catch (error) {
                console.error('Auth state check error:', error);
                window.location.href = 'Untitled-3.html';
            }
        });
        
        // Tab switching functionality
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Update tab styles
                tabs.forEach(t => {
                    t.classList.remove('active');
                    t.classList.add('text-gray-500');
                });
                tab.classList.add('active');
                tab.classList.remove('text-gray-500');
                
                // Show/hide content
                if (tab.dataset.tab === 'upcoming') {
                    upcomingRides.classList.remove('hidden');
                    pastRides.classList.add('hidden');
                } else {
                    upcomingRides.classList.add('hidden');
                    pastRides.classList.remove('hidden');
                }
            });
        });
        
        // Load user rides
        async function loadRides() {
            try {
                // Get user's rides and bookings
                const [userRides, userBookings] = await Promise.all([
                    getUserRides(currentUser.uid),
                    getUserBookings(currentUser.uid)
                ]);
                
                // Process rides
                const now = new Date();
                
                // Separate upcoming and past rides
                const upcomingUserRides = userRides.filter(ride => new Date(ride.date) > now);
                const pastUserRides = userRides.filter(ride => new Date(ride.date) <= now);
                
                // Separate upcoming and past bookings
                const upcomingBookings = userBookings.filter(booking => 
                    new Date(booking.date) > now && 
                    ['pending', 'approved'].includes(booking.status)
                );
                const pastBookings = userBookings.filter(booking => 
                    new Date(booking.date) <= now || 
                    ['cancelled', 'declined', 'completed'].includes(booking.status)
                );
                
                // Sort by date
                upcomingUserRides.sort((a, b) => new Date(a.date) - new Date(b.date));
                pastUserRides.sort((a, b) => new Date(b.date) - new Date(a.date)); // Past rides in reverse order
                upcomingBookings.sort((a, b) => new Date(a.date) - new Date(b.date));
                pastBookings.sort((a, b) => new Date(b.date) - new Date(a.date)); // Past bookings in reverse order
                
                // Remove skeletons
                const skeletons = document.querySelectorAll('.skeleton-item');
                skeletons.forEach(skeleton => skeleton.remove());
                
                // Display upcoming rides
                if (upcomingUserRides.length === 0 && upcomingBookings.length === 0) {
                    noUpcomingRidesMessage.classList.remove('hidden');
                } else {
                    noUpcomingRidesMessage.classList.add('hidden');
                    
                    // Display rides as driver
                    upcomingUserRides.forEach(ride => {
                        createRideCard(ride, 'driver', 'upcoming');
                    });
                    
                    // Display rides as passenger
                    upcomingBookings.forEach(booking => {
                        createRideCard(booking, 'passenger', 'upcoming');
                    });
                }
                
                // Display past rides
                if (pastUserRides.length === 0 && pastBookings.length === 0) {
                    noPastRidesMessage.classList.remove('hidden');
                } else {
                    noPastRidesMessage.classList.add('hidden');
                    
                    // Display past rides as driver
                    pastUserRides.forEach(ride => {
                        createRideCard(ride, 'driver', 'past');
                    });
                    
                    // Display past rides as passenger
                    pastBookings.forEach(booking => {
                        createRideCard(booking, 'passenger', 'past');
                    });
                }
            } catch (error) {
                console.error('Error loading rides:', error);
                
                // Remove skeletons
                const skeletons = document.querySelectorAll('.skeleton-item');
                skeletons.forEach(skeleton => skeleton.remove());
                
                // Show error message
                upcomingRides.innerHTML = `
                    <div class="bg-white rounded-xl shadow-sm p-6 text-center">
                        <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Error loading rides</h3>
                        <p class="text-gray-600">Something went wrong. Please try again.</p>
                        <button id="retryButton" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            Retry
                        </button>
                    </div>
                `;
                
                pastRides.innerHTML = '';
                
                document.getElementById('retryButton').addEventListener('click', () => {
                    // Reload page
                    window.location.reload();
                });
            }
        }
        
        // Create ride card
        function createRideCard(data, role, type) {
            const container = type === 'upcoming' ? upcomingRides : pastRides;
            const isPast = type === 'past';
            
            // Format date and time
            const rideDate = new Date(data.date);
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            let dateText;
            if (rideDate.toDateString() === today.toDateString()) {
                dateText = 'Today';
            } else if (rideDate.toDateString() === tomorrow.toDateString()) {
                dateText = 'Tomorrow';
            } else if (rideDate < nextWeek && rideDate > tomorrow) {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                dateText = days[rideDate.getDay()];
            } else if (isPast) {
                dateText = rideDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
            } else {
                dateText = rideDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
            
            const timeText = rideDate.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Create card
            const card = document.createElement('div');
            card.className = `bg-white rounded-xl shadow-sm p-6 ${isPast ? 'opacity-75' : ''}`;
            card.dataset.id = data.id;
            card.dataset.role = role;
            
            // Card header
            let badgeClass, badgeText;
            if (role === 'driver') {
                badgeClass = isPast ? 'bg-gray-100 text-gray-800' : 'bg-green-100 text-green-800';
                badgeText = 'As Driver';
            } else {
                badgeClass = isPast ? 'bg-gray-100 text-gray-800' : 'bg-blue-100 text-blue-800';
                badgeText = 'As Passenger';
                
                // Add status badge for bookings
                if (data.status === 'pending') {
                    badgeText += ' (Pending)';
                } else if (data.status === 'declined') {
                    badgeText += ' (Declined)';
                } else if (data.status === 'cancelled') {
                    badgeText += ' (Cancelled)';
                }
            }
            
            // Card content
            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <div class="${badgeClass} text-xs font-medium px-2.5 py-0.5 rounded">
                            ${badgeText}
                        </div>
                        <div class="text-sm text-gray-500">${dateText}, ${timeText}</div>
                    </div>
                    <span class="text-sm font-medium ${isPast ? 'text-gray-600' : 'text-green-600'}">â‚¹${data.price}/seat</span>
                </div>

                <div class="space-y-3">
                    <div class="flex items-start">
                        <i class="fas fa-circle text-green-500 text-xs mt-1 w-5"></i>
                        <div>
                            <p class="font-medium">${data.startingPoint}</p>
                            <p class="text-sm text-gray-500">Pickup: Bennett University</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-map-marker-alt text-red-500 mt-1 w-5"></i>
                        <div>
                            <p class="font-medium">${data.destination}</p>
                            <p class="text-sm text-gray-500">Drop: ${data.destination}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Card footer
            const footer = document.createElement('div');
            footer.className = 'mt-4 pt-4 border-t';
            
            if (role === 'driver') {
                // As driver
                footer.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <button class="view-passengers-btn text-sm text-gray-600 flex items-center">
                                <i class="fas fa-users mr-1"></i>
                                <span>View Passengers</span>
                            </button>
                        </div>
                        <div class="flex space-x-2">
                            ${!isPast ? `
                                <button class="view-requests-btn px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                                    <i class="fas fa-bell mr-1"></i>Requests
                                </button>
                                <button class="cancel-ride-btn px-3 py-1 text-sm text-red-600 border border-red-200 rounded-lg hover:bg-red-50">
                                    Cancel
                                </button>
                            ` : `
                                <button class="view-ride-details-btn px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Details
                                </button>
                            `}
                        </div>
                    </div>
                `;
            } else {
                // As passenger
                const otherPersonName = role === 'passenger' ? data.driverName : data.passengerName;
                
                footer.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <img src="https://via.placeholder.com/150" class="w-8 h-8 rounded-full" alt="Person">
                            <div>
                                <p class="font-medium">${otherPersonName}</p>
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-star text-yellow-400 mr-1"></i>
                                    <span>4.8</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            ${!isPast ? `
                    <button class="contact-btn px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-comments mr-1"></i>Chat
                    </button>
                                <button class="cancel-booking-btn px-3 py-1 text-sm text-red-600 border border-red-200 rounded-lg hover:bg-red-50">
                                    Cancel
                                </button>
                            ` : `
                                <button class="rate-ride-btn px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                                    Rate Ride
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }
            
            card.appendChild(footer);
            container.appendChild(card);
            
            // Add event listeners
            if (role === 'driver') {
                // View passengers button
                const viewPassengersBtn = card.querySelector('.view-passengers-btn');
                if (viewPassengersBtn) {
                    viewPassengersBtn.addEventListener('click', () => {
                        showPassengers(data.id);
                    });
                }
                
                // View requests button
                const viewRequestsBtn = card.querySelector('.view-requests-btn');
                if (viewRequestsBtn) {
                    viewRequestsBtn.addEventListener('click', () => {
                        showRequests(data.id);
                    });
                }
                
                // Cancel ride button
                const cancelRideBtn = card.querySelector('.cancel-ride-btn');
                if (cancelRideBtn) {
                    cancelRideBtn.addEventListener('click', () => {
                        cancelRide(data.id);
                    });
                }
            } else {
                // Chat button (changed from Contact)
                const contactBtn = card.querySelector('.contact-btn');
                if (contactBtn) {
                    contactBtn.addEventListener('click', () => {
                        alert('Chat functionality will be implemented soon.');
                    });
                }
                
                // Cancel booking button
                const cancelBookingBtn = card.querySelector('.cancel-booking-btn');
                if (cancelBookingBtn) {
                    cancelBookingBtn.addEventListener('click', () => {
                        cancelBooking(data.id);
                    });
                }
                
                // Rate ride button
                const rateRideBtn = card.querySelector('.rate-ride-btn');
                if (rateRideBtn) {
                    rateRideBtn.addEventListener('click', () => {
                        alert('Rating functionality will be implemented soon.');
                    });
                }
            }
        }
        
        // Show passengers for a ride
        async function showPassengers(rideId) {
            try {
                // Show modal with loading state
                passengersModal.classList.remove('hidden');
                
                // Get ride bookings
                const bookings = await getRideBookings(rideId);
                
                // Filter approved bookings
                const approvedBookings = bookings.filter(booking => booking.status === 'approved');
                
                // Create content
                if (approvedBookings.length === 0) {
                    passengersContent.innerHTML = `
                        <div class="text-center py-6">
                            <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No passengers yet</h3>
                            <p class="text-gray-600">No one has joined your ride yet.</p>
                        </div>
                    `;
                } else {
                    passengersContent.innerHTML = `
                        <div class="space-y-4">
                            ${approvedBookings.map(booking => `
                                <div class="flex items-center justify-between border-b pb-4">
                                    <div class="flex items-center space-x-3">
                                        <img src="https://via.placeholder.com/150" class="w-10 h-10 rounded-full" alt="Passenger">
                                        <div>
                                            <p class="font-medium">${booking.passengerName}</p>
                                            <p class="text-sm text-gray-600">Booking ID: ${booking.id.substring(0, 8)}</p>
                                        </div>
                                    </div>
<button class="contact-passenger-btn px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50" data-passenger-id="${booking.passengerId}">
    <i class="fas fa-comments mr-1"></i>Chat
</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    // Add event listeners to contact buttons
                    document.querySelectorAll('.contact-passenger-btn').forEach(button => {
                        button.addEventListener('click', () => {
                            alert(`Contact passenger at their registered phone number.`);
                        });
                    });
                }
            } catch (error) {
                console.error('Error showing passengers:', error);
                
                passengersContent.innerHTML = `
                    <div class="text-center py-6">
                        <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Error loading passengers</h3>
                        <p class="text-gray-600">Something went wrong. Please try again.</p>
                    </div>
                `;
            }
        }
        
        // Show booking requests for a ride
        async function showRequests(rideId) {
            try {
                // Show modal with loading state
                requestsModal.classList.remove('hidden');
                
                // Get ride bookings
                const bookings = await getRideBookings(rideId);
                
                // Filter pending bookings
                const pendingBookings = bookings.filter(booking => booking.status === 'pending');
                
                // Create content
                if (pendingBookings.length === 0) {
                    requestsContent.innerHTML = `
                        <div class="text-center py-6">
                            <i class="fas fa-bell text-gray-400 text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No pending requests</h3>
                            <p class="text-gray-600">You don't have any pending ride requests.</p>
                        </div>
                    `;
                } else {
                    requestsContent.innerHTML = `
                        <div class="space-y-4">
                            ${pendingBookings.map(booking => `
                                <div class="flex items-center justify-between border-b pb-4" data-booking-id="${booking.id}">
                                    <div class="flex items-center space-x-3">
                                        <img src="https://via.placeholder.com/150" class="w-10 h-10 rounded-full" alt="Passenger">
                                        <div>
                                            <p class="font-medium">${booking.passengerName}</p>
                                            <p class="text-sm text-gray-600">Requested to join your ride</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button class="approve-request-btn px-3 py-1 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700">
                                            Approve
                                        </button>
                                        <button class="decline-request-btn px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                                            Decline
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    // Add event listeners to buttons
                    document.querySelectorAll('.approve-request-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const bookingId = this.closest('[data-booking-id]').dataset.bookingId;
                            approveRequest(bookingId, rideId);
                        });
                    });
                    
                    document.querySelectorAll('.decline-request-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const bookingId = this.closest('[data-booking-id]').dataset.bookingId;
                            declineRequest(bookingId);
                        });
                    });
                }
            } catch (error) {
                console.error('Error showing requests:', error);
                
                requestsContent.innerHTML = `
                    <div class="text-center py-6">
                        <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Error loading requests</h3>
                        <p class="text-gray-600">Something went wrong. Please try again.</p>
                    </div>
                `;
            }
        }
        
        // Approve a booking request
        async function approveRequest(bookingId, rideId) {
            try {
                // Update booking status
                await updateBookingStatus(bookingId, 'approved');
                
                // Update ride available seats
                const ride = await getRide(rideId);
                if (ride.availableSeats > 0) {
                    await updateRide(rideId, {
                        availableSeats: ride.availableSeats - 1
                    });
                }
                
                // Remove the request from the list
                const requestElement = document.querySelector(`[data-booking-id="${bookingId}"]`);
                if (requestElement) {
                    requestElement.remove();
                }
                
                // Check if there are no more requests
                if (requestsContent.querySelectorAll('[data-booking-id]').length === 0) {
                    requestsContent.innerHTML = `
                        <div class="text-center py-6">
                            <i class="fas fa-bell text-gray-400 text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No pending requests</h3>
                            <p class="text-gray-600">You don't have any pending ride requests.</p>
                        </div>
                    `;
                }
                
                // Show success message
                alert('Booking request approved successfully!');
            } catch (error) {
                console.error('Error approving request:', error);
                alert('Failed to approve request. Please try again.');
            }
        }
        
        // Decline a booking request
        async function declineRequest(bookingId) {
            try {
                // Update booking status
                await updateBookingStatus(bookingId, 'declined');
                
                // Remove the request from the list
                const requestElement = document.querySelector(`[data-booking-id="${bookingId}"]`);
                if (requestElement) {
                    requestElement.remove();
                }
                
                // Check if there are no more requests
                if (requestsContent.querySelectorAll('[data-booking-id]').length === 0) {
                    requestsContent.innerHTML = `
                        <div class="text-center py-6">
                            <i class="fas fa-bell text-gray-400 text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No pending requests</h3>
                            <p class="text-gray-600">You don't have any pending ride requests.</p>
                        </div>
                    `;
                }
                
                // Show success message
                alert('Booking request declined.');
            } catch (error) {
                console.error('Error declining request:', error);
                alert('Failed to decline request. Please try again.');
            }
        }
        
        // Cancel a ride
        async function cancelRide(rideId) {
            if (confirm('Are you sure you want to cancel this ride? This action cannot be undone.')) {
                try {
                    // Update ride status
                    await updateRide(rideId, {
                        status: 'cancelled'
                    });
                    
                    // Remove the ride card
                    const rideCard = document.querySelector(`[data-id="${rideId}"]`);
                    if (rideCard) {
                        rideCard.remove();
                    }
                    
                    // Check if there are no more upcoming rides
                    if (upcomingRides.querySelectorAll('.bg-white').length === 0) {
                        noUpcomingRidesMessage.classList.remove('hidden');
                    }
                    
                    // Show success message
                    alert('Ride cancelled successfully.');
                } catch (error) {
                    console.error('Error cancelling ride:', error);
                    alert('Failed to cancel ride. Please try again.');
                }
            }
        }
        
        // Cancel a booking
        async function cancelBooking(bookingId) {
            if (confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) {
                try {
                    // Update booking status
                    await updateBookingStatus(bookingId, 'cancelled');
                    
                    // Remove the booking card
                    const bookingCard = document.querySelector(`[data-id="${bookingId}"]`);
                    if (bookingCard) {
                        bookingCard.remove();
                    }
                    
                    // Check if there are no more upcoming rides
                    if (upcomingRides.querySelectorAll('.bg-white').length === 0) {
                        noUpcomingRidesMessage.classList.remove('hidden');
                    }
                    
                    // Show success message
                    alert('Booking cancelled successfully.');
                } catch (error) {
                    console.error('Error cancelling booking:', error);
                    alert('Failed to cancel booking. Please try again.');
                }
            }
        }
        
        // Close modals
        closePassengersBtn.addEventListener('click', () => {
            passengersModal.classList.add('hidden');
        });
        
        closeRequestsBtn.addEventListener('click', () => {
            requestsModal.classList.add('hidden');
        });
        
        // Close modals when clicking outside
        passengersModal.addEventListener('click', (e) => {
            if (e.target === passengersModal) {
                passengersModal.classList.add('hidden');
            }
        });
        
        requestsModal.addEventListener('click', (e) => {
            if (e.target === requestsModal) {
                requestsModal.classList.add('hidden');
            }
        });

        // Chat modal elements
        const chatModal = document.getElementById('chatModal');
        const closeChatBtn = document.getElementById('closeChatBtn');
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const chatModalTitle = document.getElementById('chatModalTitle');

        // Current chat context
        let currentChatRideId = null;
        let currentChatUserId = null;
        let chatUnsubscribe = null;

        // Open chat modal and load messages
        function openChat(rideId, otherUserId, otherUserName) {
            currentChatRideId = rideId;
            currentChatUserId = otherUserId;
            chatModalTitle.textContent = `Chat with ${otherUserName}`;
            chatMessages.innerHTML = '';
            chatModal.classList.remove('hidden');

            // Unsubscribe previous listener if any
            if (chatUnsubscribe) {
                chatUnsubscribe();
            }

            // Subscribe to chat messages in Firebase
            chatUnsubscribe = subscribeToChatMessages(rideId, currentUser.uid, otherUserId, (messages) => {
                renderChatMessages(messages);
            });
        }

        // Close chat modal
        closeChatBtn.addEventListener('click', () => {
            chatModal.classList.add('hidden');
            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
        });

        // Close chat modal when clicking outside
        chatModal.addEventListener('click', (e) => {
            if (e.target === chatModal) {
                chatModal.classList.add('hidden');
                if (chatUnsubscribe) {
                    chatUnsubscribe();
                    chatUnsubscribe = null;
                }
            }
        });

        // Render chat messages
        function renderChatMessages(messages) {
            chatMessages.innerHTML = '';
            messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `max-w-xs px-4 py-2 rounded-lg break-words ${
                    msg.senderId === currentUser.uid ? 'bg-green-600 text-white self-end' : 'bg-gray-300 text-gray-900 self-start'
                }`;
                msgDiv.textContent = msg.text;
                chatMessages.appendChild(msgDiv);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle chat form submit
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;
            try {
                await sendMessage(currentChatRideId, currentUser.uid, currentChatUserId, text);
                chatInput.value = '';
            } catch (error) {
                alert('Failed to send message. Please try again.');
                console.error('Send message error:', error);
            }
        });

        // Subscribe to chat messages in Firebase (Firestore)
        function subscribeToChatMessages(rideId, userId1, userId2, callback) {
            // Import Firestore functions
            import('./firebase.js').then(({ getFirestore, collection, query, where, orderBy, onSnapshot }) => {
                const db = getFirestore();
                // Chat collection path: chats/{rideId}_{userId1}_{userId2}
                // To ensure consistent chat ID, sort user IDs lexicographically
                const userIds = [userId1, userId2].sort();
                const chatId = `${rideId}_${userIds[0]}_${userIds[1]}`;
                const chatCollection = collection(db, 'chats', chatId, 'messages');
                const q = query(chatCollection, orderBy('timestamp', 'asc'));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const messages = [];
                    querySnapshot.forEach(doc => {
                        messages.push(doc.data());
                    });
                    callback(messages);
                });
                return unsubscribe;
            });
            // Return a dummy unsubscribe function until real one is set asynchronously
            return () => {};
        }

        // Send message to Firebase (Firestore)
        async function sendMessage(rideId, senderId, receiverId, text) {
            const { getFirestore, collection, addDoc, serverTimestamp } = await import('./firebase.js');
            const db = getFirestore();
            const userIds = [senderId, receiverId].sort();
            const chatId = `${rideId}_${userIds[0]}_${userIds[1]}`;
            const chatCollection = collection(db, 'chats', chatId, 'messages');
            await addDoc(chatCollection, {
                senderId,
                receiverId,
                text,
                timestamp: serverTimestamp()
            });
        }

        // Modify chat button event listener to open chat modal
        document.querySelectorAll('.contact-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const card = e.target.closest('[data-id]');
                if (!card) return;
                const rideId = card.dataset.id;
                const role = card.dataset.role;
                let otherUserId = null;
                let otherUserName = null;

                // Determine other user info based on role and data attributes
                if (role === 'passenger') {
                    // Passenger sees driver info
                    otherUserId = card.dataset.driverId || null;
                    otherUserName = card.querySelector('.font-medium')?.textContent || 'Driver';
                } else if (role === 'driver') {
                    // Driver sees passenger info - for simplicity, open chat with first passenger (not implemented here)
                    alert('Chat with passengers will be implemented soon.');
                    return;
                }

                if (!otherUserId) {
                    alert('User information not available for chat.');
                    return;
                }

                openChat(rideId, otherUserId, otherUserName);
            });
        });
    </script>
</body>

</html>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                